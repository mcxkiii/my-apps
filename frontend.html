<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DENJI Private Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .btn-primary {
            background-color: #4f46e5;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #374151;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .keyword-btn {
             background-color: #1f2937;
             border: 1px solid #374151;
             transition: all 0.2s;
        }
        .keyword-btn.selected {
            background-color: #4f46e5;
            border-color: #6366f1;
            color: white;
        }
        .modal-bg {
            background-color: rgba(0,0,0,0.7);
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-md mx-auto">

        <!-- Login/Redeem View -->
        <div id="login-view" class="glass-effect p-8 rounded-2xl shadow-lg">
            <h1 class="text-3xl font-bold text-center mb-2">Private Access</h1>
            <p class="text-center text-gray-400 mb-6">Redeem your key to continue</p>
            <div class="space-y-4">
                <input type="text" id="key-input" placeholder="Enter your key" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="redeem-btn" class="w-full btn-primary text-white font-semibold py-3 rounded-lg">Redeem Key</button>
            </div>
        </div>

        <!-- Main App View -->
        <div id="main-view" class="hidden glass-effect p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Welcome, <span id="username-display">User</span>!</h2>
                    <p class="text-sm text-indigo-400">Key Status: <span id="key-status-display"></span></p>
                </div>
                <button id="logout-btn" class="text-sm text-gray-400 hover:text-white transition">Logout</button>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg mb-6">
                <h3 class="font-semibold mb-3 text-lg">Select a Keyword</h3>
                <div id="keywords-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    <!-- Keywords will be dynamically inserted here -->
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg">
                 <h3 class="font-semibold mb-3 text-lg">Number of Lines</h3>
                 <select id="lines-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="50">50 Lines</option>
                    <option value="100">100 Lines</option>
                    <option value="150">150 Lines</option>
                    <option value="200">200 Lines</option>
                    <option value="500">500 Lines (Lifetime/Admin)</option>
                </select>
            </div>

            <button id="generate-btn" class="w-full btn-primary text-white font-semibold py-3 rounded-lg mt-6">Generate</button>
        </div>

    </div>

    <!-- Modal for Messages/Loading -->
    <div id="modal" class="hidden fixed inset-0 modal-bg flex items-center justify-center p-4 z-50">
        <div class="glass-effect p-8 rounded-2xl shadow-lg text-center max-w-sm w-full">
            <div id="modal-content">
                <!-- Content will be injected here -->
            </div>
            <button id="modal-close-btn" class="hidden mt-6 btn-secondary text-white font-semibold py-2 px-6 rounded-lg">Close</button>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        // IMPORTANT: Replace this with the actual URL of your backend server
        const API_BASE_URL = 'http://87.106.44.40:5000'; // Example: 'http://45.86.155.42:5000'

        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('login-view');
        const mainView = document.getElementById('main-view');
        const keyInput = document.getElementById('key-input');
        const redeemBtn = document.getElementById('redeem-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const usernameDisplay = document.getElementById('username-display');
        const keyStatusDisplay = document.getElementById('key-status-display');
        const keywordsContainer = document.getElementById('keywords-container');
        const linesSelect = document.getElementById('lines-select');
        const generateBtn = document.getElementById('generate-btn');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let selectedKeyword = null;

        // --- MODAL FUNCTIONS ---
        function showModal(content, showCloseButton = false) {
            modalContent.innerHTML = content;
            modalCloseBtn.style.display = showCloseButton ? 'inline-block' : 'none';
            modal.style.display = 'flex';
        }

        function hideModal() {
            modal.style.display = 'none';
        }

        function showLoading(message = 'Loading...') {
            showModal(`<div class="flex flex-col items-center">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-lg font-semibold">${message}</p>
            </div>`);
        }

        function showMessage(title, message) {
            showModal(`<h3 class="text-xl font-bold mb-2">${title}</h3><p class="text-gray-300">${message}</p>`, true);
        }

        modalCloseBtn.addEventListener('click', hideModal);

        // --- API CALLS ---
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' }
            };
            if (body) {
                options.body = JSON.stringify(body);
            }
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'An unknown error occurred.');
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                // Handle cases where the server is unreachable
                if (error instanceof TypeError) {
                     showMessage('Connection Error', 'Could not connect to the server. Please check the API URL and make sure the server is running.');
                } else {
                     showMessage('Error', error.message);
                }
                throw error;
            }
        }

        // --- APP LOGIC ---
        function setupMainView(data) {
            localStorage.setItem('userKey', keyInput.value);
            usernameDisplay.textContent = data.username;
            keyStatusDisplay.textContent = data.key_status;
            
            keywordsContainer.innerHTML = '';
            data.keywords.forEach(kw => {
                const btn = document.createElement('button');
                btn.className = 'keyword-btn p-3 rounded-lg text-sm font-semibold';
                btn.textContent = kw.toUpperCase();
                btn.dataset.keyword = kw;
                btn.addEventListener('click', () => {
                    // Deselect others
                    document.querySelectorAll('.keyword-btn').forEach(b => b.classList.remove('selected'));
                    // Select this one
                    btn.classList.add('selected');
                    selectedKeyword = kw;
                });
                keywordsContainer.appendChild(btn);
            });

            loginView.style.display = 'none';
            mainView.style.display = 'block';
        }

        redeemBtn.addEventListener('click', async () => {
            const key = keyInput.value.trim();
            if (!key) {
                showMessage('Invalid Key', 'Please enter a key.');
                return;
            }
            showLoading('Redeeming key...');
            try {
                const data = await apiCall('/redeem', 'POST', { key });
                hideModal();
                setupMainView(data);
            } catch (error) {
                // Error message is shown by apiCall function
            }
        });
        
        generateBtn.addEventListener('click', async () => {
            const key = localStorage.getItem('userKey');
            if (!key) {
                showMessage('Error', 'User key not found. Please log in again.');
                return;
            }
            if (!selectedKeyword) {
                showMessage('Selection Needed', 'Please select a keyword.');
                return;
            }
            const lines = linesSelect.value;
            
            showLoading('Generating file...');
            try {
                const data = await apiCall('/generate', 'POST', { key, keyword: selectedKeyword, lines: parseInt(lines) });
                hideModal();
                
                // Create a downloadable file
                const blob = new Blob([data.accounts.join('\n')], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

            } catch (error) {
                // Error is handled by apiCall
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('userKey');
            keyInput.value = '';
            selectedKeyword = null;
            mainView.style.display = 'none';
            loginView.style.display = 'block';
        });

        // --- INITIALIZATION ---
        // Check if a key is already stored
        const storedKey = localStorage.getItem('userKey');
        if (storedKey) {
            keyInput.value = storedKey;
            redeemBtn.click();
        }

    </script>
</body>
</html>
